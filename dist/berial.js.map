{"version":3,"file":"berial.js","sources":["../src/index.ts"],"sourcesContent":["import { App } from './types'\r\n\r\nconst NOT_LOADED = 'NOT_LOADED'\r\nconst LOADING = 'LOADING'\r\nconst NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED'\r\nconst BOOTSTRAPPING = 'BOOTSTRAPPING'\r\nconst NOT_MOUNTED = 'NOT_MOUNTED'\r\nconst MOUNTING = 'MOUNTING'\r\nconst MOUNTED = 'MOUNTED'\r\nconst UNMOUNTING = 'UNMOUNTING'\r\n\r\nlet started = false\r\nconst apps: App[] = []\r\n\r\nexport function register(\r\n  name: string,\r\n  loadLifecycle: string,\r\n  match: any,\r\n  props: Record<string, unknown>\r\n) {\r\n  apps.push({\r\n    name,\r\n    loadLifecycle,\r\n    match,\r\n    props,\r\n    status: NOT_LOADED\r\n  } as App)\r\n}\r\n\r\nexport function start() {\r\n  started = true\r\n  reroute()\r\n}\r\n\r\nfunction reroute() {\r\n  const { loads, mounts, unmounts } = getAppChanges()\r\n  if (started) {\r\n    return perform()\r\n  } else {\r\n    return init()\r\n  }\r\n  async function init() {\r\n    await Promise.all(loads.map(runLoad))\r\n  }\r\n  async function perform() {\r\n    unmounts.map(runUnmount)\r\n    loads.map(async (app) => {\r\n      app = await runLoad(app)\r\n      app = await runBootstrap(app)\r\n      return runMount(app)\r\n    })\r\n    mounts.map(async (app) => {\r\n      app = await runBootstrap(app)\r\n      return runMount(app)\r\n    })\r\n  }\r\n}\r\n\r\nfunction getAppChanges() {\r\n  const unmounts: App[] = []\r\n  const loads: App[] = []\r\n  const mounts: App[] = []\r\n  apps.forEach((app) => {\r\n    const isActive = app.match(window.location)\r\n    switch (app.status) {\r\n      case NOT_LOADED:\r\n      case LOADING:\r\n        isActive && loads.push(app)\r\n        break\r\n      case NOT_BOOTSTRAPPED:\r\n      case BOOTSTRAPPING:\r\n      case NOT_MOUNTED:\r\n        isActive && mounts.push(app)\r\n        break\r\n      case MOUNTED:\r\n        !isActive && unmounts.push(app)\r\n    }\r\n  })\r\n  return { unmounts, loads, mounts }\r\n}\r\n\r\nfunction compose(fns: ((props: any) => Promise<any>)[]) {\r\n  fns = Array.isArray(fns) ? fns : [fns]\r\n  return (props: any) =>\r\n    fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve())\r\n}\r\n\r\nasync function runLoad(app: App) {\r\n  if (app.loaded) {\r\n    return app.loaded\r\n  }\r\n  app.loaded = Promise.resolve().then(async () => {\r\n    app.status = LOADING\r\n    let lifecycle = null\r\n    if (typeof app.loadLifecycle === 'string') {\r\n      // import html\r\n    } else {\r\n      lifecycle = await app.loadLifecycle(app.props)\r\n    }\r\n    let host = await createShadow(app)\r\n    app.status = NOT_BOOTSTRAPPED\r\n    app.bootstrap = compose(lifecycle.bootstrap)\r\n    app.mount = compose(lifecycle.mount)\r\n    app.unmount = compose(lifecycle.unmount)\r\n    app.host = host as HTMLElement\r\n    delete app.loaded\r\n    return app\r\n  })\r\n  return app.loaded\r\n}\r\n\r\nasync function createShadow(app: App) {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      class Berial extends HTMLElement {\r\n        static get componentName() {\r\n          return app.name\r\n        }\r\n        connectedCallback() {\r\n          this.attachShadow({ mode: 'open' })\r\n          resolve(this)\r\n        }\r\n        constructor() {\r\n          super()\r\n        }\r\n      }\r\n      const hasDef = window.customElements.get(app.name)\r\n      if (!hasDef) {\r\n        customElements.define(app.name, Berial)\r\n      }\r\n    } catch (e) {\r\n      reject(e)\r\n    }\r\n  })\r\n}\r\n\r\nasync function runUnmount(app: App) {\r\n  if (app.status != MOUNTED) {\r\n    return app\r\n  }\r\n  app.status = UNMOUNTING\r\n  await app.unmount(app.props)\r\n  app.status = NOT_MOUNTED\r\n  return app\r\n}\r\n\r\nasync function runBootstrap(app: App) {\r\n  if (app.status !== NOT_BOOTSTRAPPED) {\r\n    return app\r\n  }\r\n  app.status = BOOTSTRAPPING\r\n  await app.bootstrap(app.props)\r\n  app.status = NOT_MOUNTED\r\n  return app\r\n}\r\n\r\nasync function runMount(app: App) {\r\n  if (app.status !== NOT_MOUNTED) {\r\n    return app\r\n  }\r\n  app.status = MOUNTING\r\n  await app.mount(app.props)\r\n  app.status = MOUNTED\r\n  return app\r\n}\r\n\r\nconst routingEventsListeningTo = ['hashchange', 'popstate']\r\n\r\nfunction urlReroute() {\r\n  reroute()\r\n}\r\nconst capturedEventListeners = {\r\n  hashchange: [],\r\n  popstate: []\r\n} as any\r\n\r\nwindow.addEventListener('hashchange', urlReroute)\r\nwindow.addEventListener('popstate', urlReroute)\r\nconst originalAddEventListener = window.addEventListener\r\nconst originalRemoveEventListener = window.removeEventListener\r\nwindow.addEventListener = function(name: any, fn: any, ...args: any) {\r\n  if (\r\n    routingEventsListeningTo.indexOf(name) >= 0 &&\r\n    !capturedEventListeners[name].some((l: any) => l == fn)\r\n  ) {\r\n    capturedEventListeners[name].push(fn)\r\n    return\r\n  }\r\n  // @ts-ignore\r\n  return originalAddEventListener.apply(this, args)\r\n}\r\nwindow.removeEventListener = function(name: any, fn: any, ...args: any) {\r\n  if (routingEventsListeningTo.indexOf(name) >= 0) {\r\n    capturedEventListeners[name] = capturedEventListeners[name].filter(\r\n      (l: any) => l !== fn\r\n    )\r\n    return\r\n  }\r\n  //@ts-ignore\r\n  return originalRemoveEventListener.apply(this, args)\r\n}\r\n\r\nfunction patchedUpdateState(updateState: any, ...args: any) {\r\n  return function() {\r\n    const urlBefore = window.location.href\r\n    //@ts-ignore\r\n    updateState.apply(this, args)\r\n    const urlAfter = window.location.href\r\n\r\n    if (urlBefore !== urlAfter) {\r\n      // @ts-ignore\r\n      urlReroute(new PopStateEvent('popstate'))\r\n    }\r\n  }\r\n}\r\n\r\nwindow.history.pushState = patchedUpdateState(window.history.pushState)\r\nwindow.history.replaceState = patchedUpdateState(window.history.replaceState)\r\n"],"names":[],"mappings":"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"}